---
title: Economia de custos com o Azure para seus aplicativos Web
description: Aprenda como otimizar o que você paga no Azure por seus Aplicativos Web com PaaS
slug: cost-savings-with-azure
authors: [dsanchezcr]
tags: [Azure, Cost Savings, Web Apps, SQL Azure]
hide_table_of_contents: true
image: https://raw.githubusercontent.com/dsanchezcr/website/main/static/img/CostSavings/Automation.jpg
date: 2023-01-04T18:00
---
# Economia de custos com o Azure para seus aplicativos Web

## Introdução

Muitos dos nossos aplicativos Web hospedados no Azure são criados sobre um serviço PaaS, como o Serviço de Aplicativo do Azure e o SQL Azure. Esses serviços geralmente são cobrados com base na quantidade de recursos que consomem. Quanto mais recursos eles consomem, mais pagamos. No entanto, existem algumas práticas recomendadas que podemos seguir para reduzir a quantidade de recursos consumidos e, portanto, reduzir a quantidade de dinheiro que pagamos. Especialmente se estivermos executando um aplicativo Web que não é usado 24 horas por dia, 7 dias por semana ou apenas usado durante o horário comercial no mesmo fuso horário.

Um dos princípios da computação em nuvem é o **elasticidade**, o que significa que podemos aumentar ou diminuir os recursos que nosso aplicativo consome com base na demanda ou no cronograma. Esse é um ótimo recurso da nuvem, mas devemos estar cientes das implicações de custo desse recurso. Se ampliarmos nosso aplicativo para lidar com um pico de tráfego, também devemos reduzir os recursos quando o tráfego voltar ao normal.

No Serviço de Aplicativo do Azure, temos duas maneiras de escalar, aumentar ou diminuir a escala e expandir para fora ou para dentro. Aumentar ou diminuir a escala significa que podemos alterar o tamanho da VM em que nosso aplicativo está sendo executado. Expandir ou aumentar significa que podemos adicionar ou remover VMs do nosso aplicativo. Podemos aumentar ou diminuir a escala e reduzir a escala para fora ou para dentro ao mesmo tempo. Por exemplo, podemos aumentar o tamanho das VMs e adicionar mais VMs ao nosso aplicativo.

Portanto, se tivermos um aplicativo Web de produção que não seja usado 24 horas por dia, 7 dias por semana, devemos considerar o seguinte:

*   Reduza o aplicativo e o banco de dados para os recursos mínimos necessários fora do horário de pico.
*   Dimensione o aplicativo e o banco de dados para os recursos máximos necessários durante o horário de pico. (além disso, devemos habilitar o dimensionamento automático para expandir o aplicativo e adicionar mais instâncias quando necessário, [por meio das regras que você define para expandir horizontalmente ou para dentro](https://learn.microsoft.com/azure/azure-monitor/autoscale/autoscale-get-started?toc=%2Fazure%2Fapp-service%2Ftoc.json#create-your-first-autoscale-setting)).

O processo para aumentar e diminuir a escala pode ser desativado manualmente a partir do portal, conforme mostrado na imagem.

![](pathname:///img/CostSavings/AzurePortal-ScaleUp.jpg)

No entanto, esse processo pode ser tedioso e propenso a erros. Podemos automatizar o processo para aumentar e diminuir a escala do Web App e do banco de dados durante a noite e os fins de semana. Isso reduzirá a quantidade de recursos consumidos e, portanto, reduzirá a quantidade de dinheiro que pagamos.

## Solução

Nós podemos usar [Automação do Azure](https://learn.microsoft.com/azure/automation/overview) para agendar um script do PowerShell para reduzir o Aplicativo Web e o Banco de Dados durante a noite e os fins de semana. Também podemos agendar outro script do PowerShell para ampliar o Aplicativo Web e o Banco de Dados antes do horário comercial.

> Você precisará criar a conta de Automação do Azure e Executar como Conta para se conectar aos Recursos do Azure. Você pode seguir as etapas neste [artigo](https://learn.microsoft.com/azure/automation/learn/powershell-runbook-managed-identity#assign-permissions-to-managed-identities).

Vamos explorar os scripts do PowerShell que podemos usar:

### Aumentar ou diminuir a escala do aplicativo Web

```powershell
$resourceGroupName = '<Your Resource Group>'
$appServiceName = '<Your App Service>'
$tier = '<Tier you would like to scale down - For example: Basic>'
$ErrorActionPreference = 'stop'
function Login() {
	$connectionName = "AzureRunAsConnection"
	try
	{
		$servicePrincipalConnection = Get-AutomationConnection -Name $connectionName   
		Write-Verbose "Logging in to Azure..." -Verbose
		Add-AzureRmAccount `
			-ServicePrincipal `
			-TenantId $servicePrincipalConnection.TenantId `
			-ApplicationId $servicePrincipalConnection.ApplicationId `
			-CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint | Out-Null
	}
	catch {
		if (!$servicePrincipalConnection)
		{
			$ErrorMessage = "Connection $connectionName not found."
			throw $ErrorMessage
		} else{
			Write-Error -Message $_.Exception
			throw $_.Exception
		}
	}
}
filter timestamp {"[$(Get-Date -Format G)]: $_"}
Write-Output "Script started." | timestamp
Login
Write-Verbose "Login sucessful. Proceding to update service plan..." -Verbose
try{

	Set-AzureRmAppServicePlan -ResourceGroupName $resourceGroupName -Name $appServiceName -Tier $tier
	Write-Verbose "Service plan updated. Getting information about the update..." -Verbose
}
catch{
	Write-Verbose "Error... '$_.Exception'" -Verbose
	Write-Error -Message $_.Exception
	throw $_.Exception
}
$appService = Get-AzureRmAppServicePlan -ResourceGroupName $resourceGroupName -Name $appServiceName 
Write-Output "App Service Plan name: $($appService.Name)" | timestamp
Write-Output "Current App Service Plan status: $($appService.Status), tier: $($appService.Sku.Name)" | timestamp
Write-Output "Script finished."    
```

### Aumentar ou diminuir a escala do SQL Azure

```powershell
$resourceGroupName = '<Your Resource Group>'
$databaseAdminUsername = '<Your SQL Admin User>'
$databaseAdminPassword = '<Your SQL Admin Pass>'
$SqlServerName = '<Your SQL Azure Server Name>'
$DatabaseName = '<Your SQL Azure DB Name>'
$Edition = '<Tier you would like to scale down - For example: Basic>'
$PerfLevel = '<Tier you would like to scale down - For example: Basic>'
$ErrorActionPreference = 'stop'
function Login() {
    $connectionName = "AzureRunAsConnection"
    try
    {
        $servicePrincipalConnection = Get-AutomationConnection -Name $connectionName   
        Write-Verbose "Logging in to Azure..." -Verbose
        Add-AzureRmAccount `
    -ServicePrincipal `
    -TenantId $servicePrincipalConnection.TenantId `
    -ApplicationId $servicePrincipalConnection.ApplicationId `
    -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint | Out-Null
    }
    catch {
        if (!$servicePrincipalConnection)
        {
            $ErrorMessage = "Connection $connectionName not found."
            throw $ErrorMessage
        } else{
            Write-Error -Message $_.Exception
            throw $_.Exception
        }
    }
}
filter timestamp {"[$(Get-Date -Format G)]: $_"}
Write-Output "Script started." | timestamp
Login
Write-Verbose "Login sucessful. Proceding to update SQL Azure tier..." -Verbose
try{     
    $securePassword = ConvertTo-SecureString –String $databaseAdminPassword –AsPlainText -Force 
    $creds = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList $databaseAdminUsername, $securePassword
    Write-Output "SQL Credentials created" | timestamp
    $sqlContext = New-AzureSqlDatabaseServerContext -ManageUrl “https://$SqlServerName.database.windows.net” -Credential $creds
    Write-Output "SQL Context created" | timestamp
    $Db = Get-AzureSqlDatabase $sqlContext -DatabaseName $DatabaseName
    Write-Output "SQL Database selected" | timestamp
    $ServiceObjective = Get-AzureSqlDatabaseServiceObjective $sqlContext -ServiceObjectiveName $PerfLevel
    Write-Output "SQL Service Objective configured... Proceding to update edition level..." | timestamp
    Set-AzureSqlDatabase $sqlContext -Database $Db -ServiceObjective $ServiceObjective -Edition $Edition -Force
    Write-Output "Scaled the performance level of $DatabaseName to $Edition - $PerfLevel" | timestamp
    $sqlazurestatus = Get-AzureSqlDatabase $sqlContext -DatabaseName $DatabaseName
    Write-Output "Completed vertical scale." | timestamp
}
catch{
    Write-Verbose "Error... '$_.Exception'" -Verbose
    Write-Error -Message $_.Exception
    throw $_.Exception
}
```

Depois de criar os Runbooks na Automação do Azure, você pode criar as agendas e vincular os Runbooks às agendas.

![](pathname:///img/CostSavings/Automation.jpg)

## Conclusão

Vimos como podemos usar a Automação do Azure e o PowerShell para agendar o dimensionamento para cima ou para baixo do Aplicativo Web e do SQL Azure. Isso nos ajudará a economizar dinheiro e também a evitar o tempo de inatividade durante o horário comercial, adicionando os recursos que não usamos à noite.